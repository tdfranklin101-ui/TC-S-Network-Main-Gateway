<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Power Consumption & Solar Reserve Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#0b0e10; color:#e2f7ff; font-family:'Inter',sans-serif; margin:0; }
  h1 { color:#00ffe0; text-align:center; margin-top:25px; font-weight:600; }
  h2 { color:#ffa500; margin-top:40px; border-bottom:1px solid #333; padding-bottom:6px; }
  .container { width:90%; max-width:1250px; margin:0 auto; }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:15px;}
  .tile { background:#111417; border:1px solid #1c2227; border-radius:10px; padding:18px; text-align:center;}
  .tile h3 { margin:6px 0; color:#00ffe0;}
  .tile p { font-size:14px; margin:3px 0;}
  canvas { width:100%; max-width:100%; margin-top:20px; }
  .section { margin-bottom:40px;}
  .button { background:#00ffe0; color:#000; padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
  .button:hover{background:#00cfd0;}
  footer { text-align:center; font-size:12px; color:#888; margin:30px 0;}
  table { width:100%; border-collapse:collapse; font-size:13px;}
  th,td{padding:6px 8px; border:1px solid #222;}
  th{background:#11181d; color:#00ffe0;}
  tr:nth-child(even){background:#0f1215;}
  .source-card{background:#111417; border-left:4px solid #00ffe0; padding:20px; margin:15px 0; border-radius:8px;}
  .source-card h3{color:#00ffe0; margin:0 0 12px 0;}
  .source-meta{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:10px 0;}
  .meta-item{background:#0a0c0e; padding:10px; border-radius:5px;}
  .meta-label{color:#999; font-size:11px; text-transform:uppercase; margin-bottom:4px;}
  .meta-value{color:#fff; font-weight:600; font-size:14px;}
  .component-breakdown{margin-top:15px; padding:12px; background:#0f1215; border-radius:5px;}
  .component-item{display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #1a1d21;}
  .component-item:last-child{border-bottom:none;}
  .update-banner{background:#111417; border:2px solid #00ffe0; border-radius:8px; padding:16px 24px; margin:20px auto 30px; max-width:900px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;}
  .update-banner.warning{border-color:#ffa500; background:#1a1410;}
  .banner-item{display:flex; flex-direction:column; gap:4px;}
  .banner-label{color:#999; font-size:11px; text-transform:uppercase; letter-spacing:0.5px;}
  .banner-value{color:#00ffe0; font-weight:600; font-size:15px;}
  .banner-value.warning{color:#ffa500;}
  .geo-badge{display:inline-block; padding:6px 12px; background:#0a0c0e; border-radius:5px; font-size:13px; font-weight:600; margin-bottom:12px; border:1px solid #1c2227;}
  .narrative-section{margin-top:20px; border-top:1px solid #1c2227; padding-top:15px;}
  .narrative-toggle{background:#0a0c0e; border:none; color:#00ffe0; padding:10px 15px; width:100%; text-align:left; cursor:pointer; border-radius:5px; font-weight:600; font-size:14px; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;}
  .narrative-toggle:hover{background:#0f1215;}
  .narrative-content{max-height:0; overflow:hidden; transition:max-height 0.3s ease-out;}
  .narrative-content.expanded{max-height:500px; transition:max-height 0.3s ease-in;}
  .narrative-text{padding:15px; background:#0f1215; margin-top:8px; border-radius:5px; line-height:1.7; font-size:14px; color:#d1e8f0;}
  .narrative-text a{color:#00ffe0; text-decoration:none; border-bottom:1px dotted #00ffe0;}
  .narrative-text a:hover{color:#00cfd0;}
  .toggle-icon{transition:transform 0.3s; font-size:18px;}
  .toggle-icon.rotated{transform:rotate(180deg);}
  .freshness-badge{display:inline-block; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin:0 4px 4px 0;}
  .freshness-live{background:#00ff8820; color:#00ff88; border:1px solid #00ff8840;}
  .freshness-quarterly{background:#00ffe020; color:#00ffe0; border:1px solid #00ffe040;}
  .freshness-annual{background:#ffa50020; color:#ffa500; border:1px solid #ffa50040;}
  .freshness-estimate{background:#99999920; color:#999; border:1px solid #99999940;}
  .regional-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin:15px 0;}
  .region-card{background:#0a0c0e; padding:12px; border-radius:5px; border-left:3px solid #00ffe0;}
  .region-name{font-size:12px; color:#999; margin-bottom:4px;}
  .region-value{font-size:14px; color:#fff; font-weight:600;}
  .data-vintage-notice{background:#1a1410; border:1px solid #ffa500; border-radius:5px; padding:12px; margin:15px 0; font-size:13px; color:#ffa500;}
  .source-freshness-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px;}
  .freshness-indicator{display:flex; align-items:center; gap:6px; font-size:12px; padding:6px; background:#0a0c0e; border-radius:4px;}
  .freshness-dot{width:8px; height:8px; border-radius:50%;}
  .freshness-dot.live{background:#00ff88;}
  .freshness-dot.quarterly{background:#00ffe0;}
  .freshness-dot.annual{background:#ffa500;}
</style>
</head>
<body>
<div class="container">

  <h1>üåç Global Energy Intelligence Dashboard</h1>
  <p style="text-align:center;max-width:800px;margin:0 auto 20px;">
    Real-time monitoring of global power consumption converted to Solar units.
    Tracks cumulative totals since <b>April 7 2025</b> across six core sectors.
  </p>

  <div id="updateBanner" class="update-banner">
    <div class="banner-item">
      <div class="banner-label">Last Updated</div>
      <div class="banner-value" id="lastUpdate">Loading...</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Auto-Refresh</div>
      <div class="banner-value" id="nextUpdate">Daily at 03:00 UTC</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Data Vintage</div>
      <div class="banner-value" id="dataVintage">2023-2024</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Data Status</div>
      <div class="banner-value" id="dataStatus">Checking...</div>
    </div>
  </div>

  <div class="data-vintage-notice" data-ai-notice="data-source-transparency" style="display:none;" id="freshnessNotice">
    <strong>üìä Data Source Transparency:</strong> This dashboard combines three data freshness tiers:
    <div class="source-freshness-grid" style="margin-top:8px;">
      <div class="freshness-indicator">
        <span class="freshness-dot live"></span>
        <span><strong>LIVE_DAILY:</strong> Real-time API data (EIA, DOE, USDA, DOD, Mempool)</span>
      </div>
      <div class="freshness-indicator">
        <span class="freshness-dot quarterly"></span>
        <span><strong>QUARTERLY_API:</strong> Eurostat quarterly updates (Europe regions)</span>
      </div>
      <div class="freshness-indicator">
        <span class="freshness-dot annual"></span>
        <span><strong>ANNUAL_DATASET:</strong> IEA/UN 2023 authoritative datasets (Global regions)</span>
      </div>
    </div>
    Fallback hierarchy ensures 100% coverage: Live API ‚Üí IEA/UN 2023 ‚Üí Estimates (always non-zero).
  </div>

  <div class="grid" id="totalsGrid"></div>

  <div class="section">
    <h2>üìä Detailed Data Source Report</h2>
    <div id="detailedReport"></div>
  </div>

  <div class="section">
    <h2>üìà Global Energy Trend (Daily GWh/day)</h2>
    <canvas id="globalTrend"></canvas>
  </div>

  <div class="section">
    <h2>üîç Sector Breakdown (Cumulative MWh)</h2>
    <canvas id="sectorChart"></canvas>
  </div>

  <div class="section" style="text-align:center;">
    <button id="exportBtn" class="button">‚¨áÔ∏è Download Full Audit Data (JSON)</button>
  </div>

  <div class="section">
    <h2>üßæ Latest Audit Entries</h2>
    <table id="auditTable">
      <thead>
        <tr><th>Date</th><th>Category</th><th>kWh</th><th>Solar Units</th><th>Source</th><th>Verification</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>Data from verified international sources (EIA, ENTSO-E, IRENA, AEMO). All values cryptographically auditable.</footer>
</div>

<script>
// Load data freshness information for transparency
async function loadFreshnessData(){
  try {
    const res = await fetch('/api/solar-audit/last');
    const freshnessData = await res.json();
    
    // Update banner with freshness info
    if (freshnessData.timestamp) {
      document.getElementById('lastUpdate').textContent = new Date(freshnessData.timestamp).toLocaleString();
    }
    if (freshnessData.nextUpdate) {
      document.getElementById('nextUpdate').textContent = freshnessData.nextUpdate;
    }
    if (freshnessData.dataVintage) {
      document.getElementById('dataVintage').textContent = freshnessData.dataVintage;
    }
    
    // Show freshness notice with data
    const notice = document.getElementById('freshnessNotice');
    if (notice && freshnessData.categories && freshnessData.categories.length > 0) {
      notice.style.display = 'block';
      notice.setAttribute('data-ai-timestamp', freshnessData.timestamp);
      notice.setAttribute('data-ai-next-update', freshnessData.nextUpdate);
      notice.setAttribute('data-ai-vintage', freshnessData.dataVintage);
    }
    
    return freshnessData;
  } catch (error) {
    console.error('Failed to load freshness data:', error);
    return null;
  }
}

async function loadData(){
  const res = await fetch('/auditlog');
  const data = await res.json();
  
  // Load freshness data in parallel
  const freshnessPromise = loadFreshnessData();

  // --- compute totals ---
  const cats=[...new Set(data.map(x=>x.category))];
  const totals={};
  let totalKwh=0,totalSolar=0;
  data.forEach(r=>{
    if(!totals[r.category]) totals[r.category]={kwh:0,solar:0};
    totals[r.category].kwh += +r.kwh;
    totals[r.category].solar += +r.solar_units;
    totalKwh += +r.kwh;
    totalSolar += +r.solar_units;
  });

  // --- summary tiles ---
  const grid=document.getElementById('totalsGrid');
  const globalTile=document.createElement('div');
  globalTile.className='tile';
  const globalGwhDaily = totalKwh / 1e6;
  globalTile.innerHTML=`<h3>Total Global</h3>
    <p><b>${globalGwhDaily.toFixed(2)} GWh/day</b></p>
    <p>${totalKwh.toLocaleString(undefined,{maximumFractionDigits:0})} kWh</p>
    <p>${totalSolar.toFixed(2)} Solar</p>`;
  grid.appendChild(globalTile);

  cats.forEach(c=>{
    const div=document.createElement('div');
    div.className='tile';
    const gwhDaily = totals[c].kwh / 1e6;
    div.innerHTML=`<h3>${c}</h3>
      <p><b>${gwhDaily.toFixed(2)} GWh/day</b></p>
      <p>${totals[c].kwh.toLocaleString(undefined,{maximumFractionDigits:0})} kWh</p>
      <p>${totals[c].solar.toFixed(2)} Solar</p>`;
    grid.appendChild(div);
  });

  // --- timestamp banner ---
  const latestTimestamp = data.length > 0 ? data.reduce((latest, record) => {
    const recordDate = new Date(record.day);
    const latestDate = new Date(latest);
    return recordDate > latestDate ? record.day : latest;
  }, data[0].day) : null;

  if (latestTimestamp) {
    const lastUpdateDate = new Date(latestTimestamp);
    const now = new Date();
    const hoursSinceUpdate = (now - lastUpdateDate) / (1000 * 60 * 60);
    
    document.getElementById('lastUpdate').textContent = lastUpdateDate.toISOString();
    
    const banner = document.getElementById('updateBanner');
    const statusEl = document.getElementById('dataStatus');
    
    if (hoursSinceUpdate > 24) {
      banner.classList.add('warning');
      statusEl.classList.add('warning');
      statusEl.textContent = `‚ö†Ô∏è Data ${Math.floor(hoursSinceUpdate)}h old`;
    } else {
      statusEl.textContent = '‚úì Current';
    }
  }

  // --- detailed source report ---
  const reportDiv = document.getElementById('detailedReport');
  const categoryDetails = {
    'housing': {
      icon: 'üè†',
      name: 'Housing (Residential)',
      location: 'United States',
      geographicScope: 'üá∫üá∏ United States Total',
      methodology: 'Live EIA API - US Total monthly retail electricity sales',
      narrative: 'Housing energy consumption tracks daily electricity usage across all residential buildings in the United States. This metric is critical because residential buildings account for approximately 40% of total US electricity demand, making them a primary target for solar adoption and energy efficiency improvements. Data is sourced from the EIA\'s monthly retail electricity sales reports (residential sector), converted to daily averages by dividing total monthly consumption (in GWh) by days in the month. Current scope covers the entire United States; regional breakdowns may be added in future updates. Source: <a href="https://www.eia.gov/electricity/data/browser/" target="_blank">EIA Electricity Data Browser</a>',
      components: null
    },
    'manufacturing': {
      icon: 'üè≠',
      name: 'Manufacturing (Industrial)',
      location: 'United States',
      geographicScope: 'üá∫üá∏ United States Total',
      methodology: 'Live EIA API - US Total monthly industrial electricity sales',
      narrative: 'Manufacturing energy consumption captures the industrial electricity demand across all US manufacturing facilities, including heavy industry, light manufacturing, and processing plants. This sector represents approximately 25% of total US electricity consumption and presents massive opportunities for solar integration through on-site generation and energy storage. Data is sourced from the EIA\'s industrial sector electricity sales, aggregated monthly and converted to daily averages (total GWh √∑ days in month). Coverage includes all 50 states with verified utility-reported data. Transitioning this sector to renewable energy is essential for achieving carbon neutrality. Source: <a href="https://www.eia.gov/electricity/data/browser/" target="_blank">EIA Electricity Data Browser</a>',
      components: null
    },
    'food': {
      icon: 'üåæ',
      name: 'Food & Agriculture',
      location: 'United States',
      geographicScope: 'üá∫üá∏ United States Total',
      methodology: 'IEA/USDA Agricultural Energy Calculation',
      narrative: 'Food and agriculture energy consumption encompasses the entire US food system from farm to fork, including crop cultivation, livestock operations, food processing, cold storage, and distribution networks. This sector is uniquely positioned for solar adoption due to abundant land availability and high daytime energy demand alignment with solar generation peaks. Calculated using USDA and IEA agricultural energy data (1.75 quadrillion BTU/year = 512.87 TWh/year √∑ 365 days = 1,405 GWh/day). Current methodology uses annualized estimates; real-time feed integration is planned for future updates. Source: <a href="https://www.usda.gov/energy" target="_blank">USDA Energy Office</a>',
      components: [
        {name: 'Annual Energy Consumption', value: '1.75 quadrillion BTU/year'},
        {name: 'Annualized (TWh/year)', value: '512.87 TWh'},
        {name: 'Daily Average', value: '1,405.13 GWh/day'}
      ]
    },
    'money': {
      icon: 'üí∞',
      name: 'Money & Blockchain',
      location: 'Global',
      geographicScope: 'üåç Global',
      methodology: 'Live Bitcoin Network Hashrate Calculation',
      narrative: 'Money and blockchain energy consumption measures the global electricity demand of cryptocurrency mining networks, primarily Bitcoin, Ethereum, and other proof-of-work systems. This sector is critical for solar transition because crypto mining operations can serve as flexible grid load balancers, absorbing excess renewable generation during peak production hours. Bitcoin energy is calculated from network hashrate (1,087 EH/s √ó 35 W/TH efficiency = 913 GWh/day). Ethereum\'s transition to proof-of-stake has reduced its footprint by 99.95%. This is the only truly global category, with mining operations distributed worldwide. Source: <a href="https://cbeci.org" target="_blank">Cambridge Bitcoin Electricity Consumption Index</a>',
      components: [
        {name: 'Bitcoin Network', value: '~1,087 EH/s √ó 35 W/TH = 913 GWh/day'},
        {name: 'Network Efficiency Model', value: '35 W/TH (25-50 W/TH range)'},
        {name: 'Ethereum + Solana (est)', value: 'Included in total'}
      ]
    },
    'digital-services': {
      icon: 'üíª',
      name: 'Digital Services (Data Centers)',
      location: 'United States',
      geographicScope: 'üá∫üá∏ United States Total',
      methodology: 'LBNL Data Center Energy Study Calculation',
      narrative: 'Digital services energy consumption tracks electricity usage across all US data centers, including hyperscale facilities (AWS, Google, Microsoft), enterprise data centers, and colocation providers. This sector is growing 10-15% annually and represents a strategic target for solar adoption due to predictable 24/7 baseload demand that pairs well with solar + storage solutions. Based on Lawrence Berkeley National Laboratory research estimating 97 TWh/year total US data center energy consumption (97,000 GWh √∑ 365 = 265.75 GWh/day). Coverage includes all facility types from edge computing to massive cloud infrastructure. Source: <a href="https://eta.lbl.gov/publications/united-states-data-center-energy" target="_blank">LBNL Data Center Energy Report</a>',
      components: [
        {name: 'Annual US Data Center Energy', value: '97 TWh/year'},
        {name: 'Daily Average', value: '265.75 GWh/day'},
        {name: 'Coverage', value: 'Hyperscale + Enterprise + Colocation'}
      ]
    },
    'transport': {
      icon: 'üöó',
      name: 'Transportation Electrification',
      location: 'United States',
      geographicScope: 'üá∫üá∏ United States Total',
      methodology: 'DOE/AFDC Comprehensive Calculation',
      narrative: 'Transportation electrification measures daily electricity consumption from the rapidly expanding electric vehicle ecosystem, including passenger EVs, commercial delivery fleets, public transit systems, and charging infrastructure. This sector is the fastest-growing energy demand category and represents the most direct path for solar adoption through home charging integration and solar carports. Calculated from DOE/AFDC data: 3.3M EVs √ó 40 miles/day √ó 0.35 kWh/mile = 46.2 GWh, plus public transit (15 GWh), commercial fleets (8 GWh), and infrastructure overhead (2.3 GWh) = 71.5 GWh/day total. US-only scope. Source: <a href="https://afdc.energy.gov/data/" target="_blank">DOE Alternative Fuels Data Center</a>',
      components: [
        {name: 'Electric Vehicles', value: '3.3M vehicles √ó 40 mi/day √ó 0.35 kWh/mi = 46.2 GWh'},
        {name: 'Public Transit', value: 'Electric buses + metro + rail = 15.0 GWh'},
        {name: 'Commercial Fleets', value: 'Amazon, UPS, Uber/Lyft = 8.0 GWh'},
        {name: 'Charging Infrastructure', value: '5% overhead = 2.3 GWh'},
        {name: 'Total', value: '71.5 GWh/day'}
      ]
    }
  };

  // Create sorted categories array for detailed report (don't mutate original data)
  const sortedCategories = [...cats].sort((a,b) => totals[b].kwh - totals[a].kwh);
  
  // Build one card per category using aggregated totals
  sortedCategories.forEach(category => {
    const details = categoryDetails[category];
    if (!details) return;
    
    // Get the latest record for this category to extract source info
    const latestRecord = data.find(r => r.category === category);
    if (!latestRecord) return;
    
    const gwhDaily = totals[category].kwh / 1e6;
    const card = document.createElement('div');
    card.className = 'source-card';
    
    let componentsHTML = '';
    if (details.components) {
      componentsHTML = `
        <div class="component-breakdown">
          <div class="meta-label">Component Breakdown</div>
          ${details.components.map(comp => `
            <div class="component-item">
              <span>${comp.name}</span>
              <span style="color:#00ffe0; font-weight:600;">${comp.value}</span>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    const narrativeId = `narrative-${category}`;
    
    card.innerHTML = `
      <h3>${details.icon} ${details.name}</h3>
      <div class="geo-badge">${details.geographicScope}</div>
      <div class="source-meta">
        <div class="meta-item">
          <div class="meta-label">Daily Energy</div>
          <div class="meta-value">${gwhDaily.toFixed(2)} GWh/day</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Total kWh</div>
          <div class="meta-value">${totals[category].kwh.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Solar Units</div>
          <div class="meta-value">${totals[category].solar.toFixed(2)}</div>
        </div>
      </div>
      <div class="source-meta" style="margin-top:10px;">
        <div class="meta-item">
          <div class="meta-label">Data Source</div>
          <div class="meta-value" style="font-size:12px;">${latestRecord.source}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Location</div>
          <div class="meta-value">${details.location}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Verification</div>
          <div class="meta-value">${latestRecord.verification_level}</div>
        </div>
      </div>
      <div class="meta-item" style="margin-top:10px;">
        <div class="meta-label">Methodology</div>
        <div class="meta-value" style="font-size:12px; line-height:1.5;">${details.methodology}</div>
      </div>
      ${componentsHTML}
      <div class="narrative-section">
        <button class="narrative-toggle" data-target="${narrativeId}">
          <span>üìñ About This Metric</span>
          <span class="toggle-icon">‚ñº</span>
        </button>
        <div id="${narrativeId}" class="narrative-content">
          <div class="narrative-text">${details.narrative}</div>
        </div>
      </div>
    `;
    
    reportDiv.appendChild(card);
  });
  
  // Add toggle functionality for narratives
  document.querySelectorAll('.narrative-toggle').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const content = document.getElementById(targetId);
      const icon = this.querySelector('.toggle-icon');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.classList.remove('rotated');
      } else {
        content.classList.add('expanded');
        icon.classList.add('rotated');
      }
    });
  });

  // --- global trend ---
  const days=[...new Set(data.map(x=>x.day))].sort();
  const dayTotals=days.map(d=>data.filter(x=>x.day===d).reduce((s,x)=>s+(+x.kwh),0)/1e6);
  new Chart(document.getElementById('globalTrend'),{
    type:'line',
    data:{labels:days,datasets:[{label:'Global Energy (GWh/day)',data:dayTotals,borderColor:'#00ffe0',tension:0.3,fill:false}]},
    options:{
      plugins:{
        tooltip:{
          callbacks:{
            label: function(context) {
              return `${context.parsed.y.toFixed(2)} GWh/day`;
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#ccc'}},
        y:{
          ticks:{color:'#ccc'},
          beginAtZero:true,
          title:{
            display:true,
            text:'GWh/day',
            color:'#00ffe0'
          }
        }
      }
    }
  });

  // --- sector breakdown chart ---
  // Sort categories by energy consumption for better visualization
  const sortedCats = cats.sort((a,b) => totals[b].kwh - totals[a].kwh);
  new Chart(document.getElementById('sectorChart'),{
    type:'bar',
    data:{
      labels:sortedCats,
      datasets:[{
        label:'Cumulative MWh',
        data:sortedCats.map(c=>totals[c].kwh/1e3),
        backgroundColor:'#00ffe0'
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label: function(context) {
              const gwh = context.parsed.y / 1000;
              return `${gwh.toFixed(2)} GWh/day`;
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#ccc'}},
        y:{
          type:'logarithmic',
          ticks:{
            color:'#ccc',
            callback: function(value) {
              if (value >= 1000000) return (value/1000000).toFixed(0) + 'M';
              if (value >= 1000) return (value/1000).toFixed(0) + 'K';
              return value;
            }
          },
          title:{
            display:true,
            text:'MWh (log scale)',
            color:'#00ffe0'
          }
        }
      }
    }
  });

  // --- audit table ---
  const tbody=document.querySelector('#auditTable tbody');
  data.slice(0,50).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.day}</td><td>${r.category}</td>
      <td>${(+r.kwh).toLocaleString()}</td><td>${(+r.solar_units).toFixed(3)}</td>
      <td>${r.source}</td><td>${r.verification_level}</td>`;
    tbody.appendChild(tr);
  });

  // --- export JSON ---
  document.getElementById('exportBtn').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='global_energy_audit.json';a.click();
    URL.revokeObjectURL(url);
  });
}
loadData();
</script>
</body>
</html>
