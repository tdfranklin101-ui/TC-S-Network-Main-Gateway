<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Power Consumption & Solar Reserve Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#0b0e10; color:#e2f7ff; font-family:'Inter',sans-serif; margin:0; }
  h1 { color:#00ffe0; text-align:center; margin-top:25px; font-weight:600; }
  h2 { color:#ffa500; margin-top:40px; border-bottom:1px solid #333; padding-bottom:6px; }
  .container { width:90%; max-width:1250px; margin:0 auto; }
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:15px;}
  .tile { background:#111417; border:1px solid #1c2227; border-radius:10px; padding:18px; text-align:center;}
  .tile h3 { margin:6px 0; color:#00ffe0;}
  .tile p { font-size:14px; margin:3px 0;}
  canvas { width:100%; max-width:100%; margin-top:20px; }
  .section { margin-bottom:40px;}
  .button { background:#00ffe0; color:#000; padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;}
  .button:hover{background:#00cfd0;}
  footer { text-align:center; font-size:12px; color:#888; margin:30px 0;}
  table { width:100%; border-collapse:collapse; font-size:13px;}
  th,td{padding:6px 8px; border:1px solid #222;}
  th{background:#11181d; color:#00ffe0;}
  tr:nth-child(even){background:#0f1215;}
  .source-card{background:#111417; border-left:4px solid #00ffe0; padding:20px; margin:15px 0; border-radius:8px;}
  .source-card h3{color:#00ffe0; margin:0 0 12px 0;}
  .source-meta{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:10px 0;}
  .meta-item{background:#0a0c0e; padding:10px; border-radius:5px;}
  .meta-label{color:#999; font-size:11px; text-transform:uppercase; margin-bottom:4px;}
  .meta-value{color:#fff; font-weight:600; font-size:14px;}
  .component-breakdown{margin-top:15px; padding:12px; background:#0f1215; border-radius:5px;}
  .component-item{display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #1a1d21;}
  .component-item:last-child{border-bottom:none;}
  .update-banner{background:#111417; border:2px solid #00ffe0; border-radius:8px; padding:16px 24px; margin:20px auto 30px; max-width:900px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;}
  .update-banner.warning{border-color:#ffa500; background:#1a1410;}
  .banner-item{display:flex; flex-direction:column; gap:4px;}
  .banner-label{color:#999; font-size:11px; text-transform:uppercase; letter-spacing:0.5px;}
  .banner-value{color:#00ffe0; font-weight:600; font-size:15px;}
  .banner-value.warning{color:#ffa500;}
  .geo-badge{display:inline-block; padding:6px 12px; background:#0a0c0e; border-radius:5px; font-size:13px; font-weight:600; margin-bottom:12px; border:1px solid #1c2227;}
  .narrative-section{margin-top:20px; border-top:1px solid #1c2227; padding-top:15px;}
  .narrative-toggle{background:#0a0c0e; border:none; color:#00ffe0; padding:10px 15px; width:100%; text-align:left; cursor:pointer; border-radius:5px; font-weight:600; font-size:14px; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;}
  .narrative-toggle:hover{background:#0f1215;}
  .narrative-content{max-height:0; overflow:hidden; transition:max-height 0.3s ease-out;}
  .narrative-content.expanded{max-height:500px; transition:max-height 0.3s ease-in;}
  .narrative-text{padding:15px; background:#0f1215; margin-top:8px; border-radius:5px; line-height:1.7; font-size:14px; color:#d1e8f0;}
  .narrative-text a{color:#00ffe0; text-decoration:none; border-bottom:1px dotted #00ffe0;}
  .narrative-text a:hover{color:#00cfd0;}
  .toggle-icon{transition:transform 0.3s; font-size:18px;}
  .toggle-icon.rotated{transform:rotate(180deg);}
  .freshness-badge{display:inline-block; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin:0 4px 4px 0;}
  .freshness-live{background:#00ff8820; color:#00ff88; border:1px solid #00ff8840;}
  .freshness-quarterly{background:#00ffe020; color:#00ffe0; border:1px solid #00ffe040;}
  .freshness-annual{background:#ffa50020; color:#ffa500; border:1px solid #ffa50040;}
  .freshness-estimate{background:#99999920; color:#999; border:1px solid #99999940;}
  .regional-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin:15px 0;}
  .region-card{background:#0a0c0e; padding:12px; border-radius:5px; border-left:3px solid #00ffe0;}
  .region-name{font-size:12px; color:#999; margin-bottom:4px;}
  .region-value{font-size:14px; color:#fff; font-weight:600;}
  .data-vintage-notice{background:#1a1410; border:1px solid #ffa500; border-radius:5px; padding:12px; margin:15px 0; font-size:13px; color:#ffa500;}
  .source-freshness-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px;}
  .freshness-indicator{display:flex; align-items:center; gap:6px; font-size:12px; padding:6px; background:#0a0c0e; border-radius:4px;}
  .freshness-dot{width:8px; height:8px; border-radius:50%;}
  .freshness-dot.live{background:#00ff88;}
  .freshness-dot.quarterly{background:#00ffe0;}
  .freshness-dot.annual{background:#ffa500;}
  .coverage-table{width:100%; border-collapse:collapse; font-size:12px; background:#0f1215; border-radius:8px; overflow:hidden;}
  .coverage-table th{background:#11181d; color:#00ffe0; padding:12px 8px; text-align:left; font-weight:600; border:1px solid #222;}
  .coverage-table td{padding:10px 8px; border:1px solid #222; vertical-align:top;}
  .coverage-table tbody tr:hover{background:#111417;}
  .coverage-table .category-cell{color:#fff; font-weight:600;}
  .coverage-table .region-cell{font-size:11px;}
  .coverage-table .region-value{color:#00ffe0; font-weight:600; display:block; margin-bottom:2px;}
  .coverage-table .region-freshness{font-size:10px; opacity:0.8;}
  .matrix-header{position:sticky; top:0; z-index:10;}
</style>
</head>
<body>
<div class="container">

  <h1>üåç Global Energy Intelligence Dashboard</h1>
  <p style="text-align:center;max-width:800px;margin:0 auto 20px;">
    Real-time monitoring of global power consumption converted to Solar units.
    Tracks cumulative totals since <b>April 7 2025</b> across <b>8 categories</b> and <b>6 global regions</b> (<b>48 data points</b>).
  </p>

  <div id="updateBanner" class="update-banner">
    <div class="banner-item">
      <div class="banner-label">Last Updated</div>
      <div class="banner-value" id="lastUpdate">Loading...</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Auto-Refresh</div>
      <div class="banner-value" id="nextUpdate">Daily at 03:00 UTC</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Data Vintage</div>
      <div class="banner-value" id="dataVintage">2023-2024</div>
    </div>
    <div class="banner-item">
      <div class="banner-label">Data Status</div>
      <div class="banner-value" id="dataStatus">Checking...</div>
    </div>
  </div>

  <div class="data-vintage-notice" data-ai-notice="data-source-transparency" style="display:none;" id="freshnessNotice">
    <strong>üìä Data Source Transparency:</strong> This dashboard combines three data freshness tiers:
    <div class="source-freshness-grid" style="margin-top:8px;">
      <div class="freshness-indicator">
        <span class="freshness-dot live"></span>
        <span><strong>LIVE_DAILY:</strong> Real-time API data (EIA, DOE, USDA, DOD, Mempool)</span>
      </div>
      <div class="freshness-indicator">
        <span class="freshness-dot quarterly"></span>
        <span><strong>QUARTERLY_API:</strong> Eurostat quarterly updates (Europe regions)</span>
      </div>
      <div class="freshness-indicator">
        <span class="freshness-dot annual"></span>
        <span><strong>ANNUAL_DATASET:</strong> IEA/UN 2023 authoritative datasets (Global regions)</span>
      </div>
    </div>
    Fallback hierarchy ensures 100% coverage: Live API ‚Üí IEA/UN 2023 ‚Üí Estimates (always non-zero).
  </div>

  <div class="grid" id="totalsGrid"></div>

  <div class="section">
    <h2>üåê Global Coverage Matrix (8 Categories √ó 6 Regions = 48 Data Points)</h2>
    <p style="color:#999; font-size:14px; margin-bottom:15px;">
      Complete energy audit coverage with real-time freshness indicators. Green=Live API, Cyan=Quarterly, Orange=Annual datasets.
    </p>
    <div id="coverageMatrix" style="overflow-x:auto;"></div>
  </div>

  <div class="section">
    <h2>üìä Detailed Data Source Report</h2>
    <div id="detailedReport"></div>
  </div>

  <div class="section">
    <h2>üìà Global Energy Trend (Daily GWh/day)</h2>
    <canvas id="globalTrend"></canvas>
  </div>

  <div class="section">
    <h2>üîç Sector Breakdown (Cumulative MWh)</h2>
    <canvas id="sectorChart"></canvas>
  </div>

  <div class="section" style="text-align:center;">
    <button id="exportBtn" class="button">‚¨áÔ∏è Download Full Audit Data (JSON)</button>
  </div>

  <div class="section">
    <h2>üßæ Latest Audit Entries</h2>
    <table id="auditTable">
      <thead>
        <tr><th>Date</th><th>Category</th><th>kWh</th><th>Solar Units</th><th>Source</th><th>Verification</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>Data from verified international sources (EIA, ENTSO-E, IRENA, AEMO). All values cryptographically auditable.</footer>
</div>

<script>
// Build 8√ó6 Coverage Matrix with freshness indicators
function buildCoverageMatrix(freshnessData) {
  const regions = ['GLOBAL_ASIA', 'GLOBAL_NORTH_AMERICA', 'GLOBAL_EUROPE', 'GLOBAL_AFRICA', 'GLOBAL_LATIN_AMERICA', 'GLOBAL_OCEANIA'];
  const regionNames = {'GLOBAL_ASIA': 'Asia', 'GLOBAL_NORTH_AMERICA': 'N. America', 'GLOBAL_EUROPE': 'Europe', 'GLOBAL_AFRICA': 'Africa', 'GLOBAL_LATIN_AMERICA': 'Latin America', 'GLOBAL_OCEANIA': 'Oceania'};
  const categoryIcons = {'housing': 'üè†', 'manufacturing': 'üè≠', 'digital-services': 'üíª', 'transport': 'üöó', 'food': 'üåæ', 'money': 'üí∞', 'ai-ml': 'ü§ñ', 'government-military': 'üèõÔ∏è'};
  
  // Build category-region map from freshness data
  const categoryRegionMap = {};
  freshnessData.categories.forEach(cat => {
    const categoryKey = cat.category;
    categoryRegionMap[categoryKey] = {};
    
    if (cat.regions && cat.regions.length > 0) {
      cat.regions.forEach(region => {
        categoryRegionMap[categoryKey][region.code] = {
          energyKwh: region.energyKwh,
          energySolar: region.energySolar,
          dataFreshness: region.dataFreshness
        };
      });
    }
  });
  
  // Build table
  const container = document.getElementById('coverageMatrix');
  let html = `<table class="coverage-table">
    <thead class="matrix-header">
      <tr>
        <th style="width:150px;">Category</th>
        ${regions.map(r => `<th>${regionNames[r]}</th>`).join('')}
      </tr>
    </thead>
    <tbody>`;
  
  // Get all category keys (convert to kebab-case if needed)
  const categories = Object.keys(categoryRegionMap);
  
  categories.forEach(category => {
    const icon = categoryIcons[category] || 'üìä';
    const categoryName = category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    
    html += `<tr>
      <td class="category-cell">${icon} ${categoryName}</td>`;
    
    regions.forEach(regionCode => {
      const regionData = categoryRegionMap[category]?.[regionCode];
      if (regionData) {
        const gwhDaily = (regionData.energyKwh / 1e6).toFixed(2);
        const freshness = regionData.dataFreshness || 'UNKNOWN';
        const freshnessClass = freshness === 'LIVE_DAILY' ? 'freshness-live' : 
                              freshness === 'QUARTERLY_API' ? 'freshness-quarterly' : 
                              freshness === 'ANNUAL_DATASET' ? 'freshness-annual' : 'freshness-estimate';
        const freshnessLabel = freshness.replace(/_/g, ' ');
        
        html += `<td class="region-cell" data-ai-region="${regionCode}" data-ai-category="${category}" data-ai-freshness="${freshness}">
          <span class="region-value">${gwhDaily} GWh/day</span>
          <span class="region-freshness ${freshnessClass}">${freshnessLabel}</span>
        </td>`;
      } else {
        html += `<td class="region-cell" style="opacity:0.5;">No data</td>`;
      }
    });
    
    html += `</tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
}

// Load data freshness information for transparency
async function loadFreshnessData(){
  try {
    const res = await fetch('/api/solar-audit/last');
    const freshnessData = await res.json();
    
    // Update banner with freshness info
    if (freshnessData.timestamp) {
      document.getElementById('lastUpdate').textContent = new Date(freshnessData.timestamp).toLocaleString();
    }
    if (freshnessData.nextUpdate) {
      document.getElementById('nextUpdate').textContent = freshnessData.nextUpdate;
    }
    if (freshnessData.dataVintage) {
      document.getElementById('dataVintage').textContent = freshnessData.dataVintage;
    }
    
    // Show freshness notice with data
    const notice = document.getElementById('freshnessNotice');
    if (notice && freshnessData.categories && freshnessData.categories.length > 0) {
      notice.style.display = 'block';
      notice.setAttribute('data-ai-timestamp', freshnessData.timestamp);
      notice.setAttribute('data-ai-next-update', freshnessData.nextUpdate);
      notice.setAttribute('data-ai-vintage', freshnessData.dataVintage);
    }
    
    return freshnessData;
  } catch (error) {
    console.error('Failed to load freshness data:', error);
    return null;
  }
}

async function loadData(){
  const res = await fetch('/auditlog');
  const data = await res.json();
  
  // Load freshness data in parallel
  const freshnessData = await loadFreshnessData();

  // --- Build 8√ó6 Coverage Matrix ---
  if (freshnessData && freshnessData.categories) {
    buildCoverageMatrix(freshnessData);
  }

  // --- compute TRUE GLOBAL TOTALS from all 6 regions ---
  const grid = document.getElementById('totalsGrid');
  let trueGlobalTotalKwh = 0;
  let trueGlobalTotalSolar = 0;
  const categoryTotals = {};
  
  // Calculate TRUE global totals from freshness data (all 6 regions)
  if (freshnessData && freshnessData.categories) {
    freshnessData.categories.forEach(categoryData => {
      let categoryTotalKwh = 0;
      let categoryTotalSolar = 0;
      
      if (categoryData.regions && categoryData.regions.length > 0) {
        categoryData.regions.forEach(region => {
          categoryTotalKwh += region.energyKwh || 0;
          categoryTotalSolar += region.energySolar || 0;
        });
      }
      
      categoryTotals[categoryData.category] = {
        kwh: categoryTotalKwh,
        solar: categoryTotalSolar
      };
      
      trueGlobalTotalKwh += categoryTotalKwh;
      trueGlobalTotalSolar += categoryTotalSolar;
    });
  }

  // --- summary tiles with TRUE GLOBAL TOTALS ---
  const globalTile = document.createElement('div');
  globalTile.className = 'tile';
  const globalGwhDaily = trueGlobalTotalKwh / 1e6;
  globalTile.innerHTML = `<h3>Total Global</h3>
    <p><b>${globalGwhDaily.toFixed(2)} GWh/day</b></p>
    <p>${trueGlobalTotalKwh.toLocaleString(undefined,{maximumFractionDigits:0})} kWh</p>
    <p>${trueGlobalTotalSolar.toFixed(2)} Solar</p>
    <div style="font-size:10px; color:#00ffe0; margin-top:5px;">üåç All 6 Regions</div>`;
  grid.appendChild(globalTile);

  // Category tiles with TRUE global totals (all regions)
  Object.entries(categoryTotals).forEach(([category, totals]) => {
    const div = document.createElement('div');
    div.className = 'tile';
    const gwhDaily = totals.kwh / 1e6;
    const categoryName = category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const icon = {
      'housing': 'üè†', 
      'manufacturing': 'üè≠', 
      'digital-services': 'üíª', 
      'transport': 'üöó', 
      'food': 'üåæ', 
      'money': 'üí∞', 
      'ai-ml': 'ü§ñ', 
      'government-military': 'üèõÔ∏è'
    }[category] || 'üìä';
    
    div.innerHTML = `<h3>${icon} ${categoryName}</h3>
      <p><b>${gwhDaily.toFixed(2)} GWh/day</b></p>
      <p>${totals.kwh.toLocaleString(undefined,{maximumFractionDigits:0})} kWh</p>
      <p>${totals.solar.toFixed(2)} Solar</p>
      <div style="font-size:10px; color:#999; margin-top:5px;">Global total</div>`;
    grid.appendChild(div);
  });

  // --- timestamp banner ---
  const latestTimestamp = data.length > 0 ? data.reduce((latest, record) => {
    const recordDate = new Date(record.day);
    const latestDate = new Date(latest);
    return recordDate > latestDate ? record.day : latest;
  }, data[0].day) : null;

  if (latestTimestamp) {
    const lastUpdateDate = new Date(latestTimestamp);
    const now = new Date();
    const hoursSinceUpdate = (now - lastUpdateDate) / (1000 * 60 * 60);
    
    document.getElementById('lastUpdate').textContent = lastUpdateDate.toISOString();
    
    const banner = document.getElementById('updateBanner');
    const statusEl = document.getElementById('dataStatus');
    
    if (hoursSinceUpdate > 24) {
      banner.classList.add('warning');
      statusEl.classList.add('warning');
      statusEl.textContent = `‚ö†Ô∏è Data ${Math.floor(hoursSinceUpdate)}h old`;
    } else {
      statusEl.textContent = '‚úì Current';
    }
  }

  // --- detailed source report with ALL REGIONAL BREAKDOWNS ---
  const reportDiv = document.getElementById('detailedReport');
  
  // Category metadata
  const categoryIcons = {
    'housing': 'üè†', 
    'manufacturing': 'üè≠', 
    'digital-services': 'üíª', 
    'transport': 'üöó', 
    'food': 'üåæ', 
    'money': 'üí∞', 
    'ai-ml': 'ü§ñ', 
    'government-military': 'üèõÔ∏è'
  };
  
  const regionNames = {
    'GLOBAL_ASIA': 'Asia',
    'GLOBAL_NORTH_AMERICA': 'North America',
    'GLOBAL_EUROPE': 'Europe',
    'GLOBAL_AFRICA': 'Africa',
    'GLOBAL_LATIN_AMERICA': 'Latin America',
    'GLOBAL_OCEANIA': 'Oceania'
  };
  
  // Build detailed cards from freshness data with ALL regional breakdowns
  if (freshnessData && freshnessData.categories) {
    freshnessData.categories.forEach(categoryData => {
      const category = categoryData.category;
      const icon = categoryIcons[category] || 'üìä';
      const categoryName = category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      // Calculate TRUE global total from all 6 regions
      let globalTotalKwh = 0;
      let globalTotalSolar = 0;
      
      if (categoryData.regions && categoryData.regions.length > 0) {
        categoryData.regions.forEach(region => {
          globalTotalKwh += region.energyKwh || 0;
          globalTotalSolar += region.energySolar || 0;
        });
      }
      
      const globalGwhDaily = (globalTotalKwh / 1e6).toFixed(2);
      
      const card = document.createElement('div');
      card.className = 'source-card';
      
      // Build regional breakdown table
      let regionsHTML = '';
      if (categoryData.regions && categoryData.regions.length > 0) {
        regionsHTML = `
          <div class="regional-breakdown" style="margin-top:15px;">
            <div class="meta-label" style="margin-bottom:10px;">üåç Regional Breakdown (6 Regions):</div>
            <div style="display:grid; gap:8px;">
              ${categoryData.regions.map(region => {
                const regionName = regionNames[region.code] || region.code;
                const regionGwh = (region.energyKwh / 1e6).toFixed(2);
                const regionSolar = region.energySolar.toFixed(2);
                const freshness = region.dataFreshness || 'UNKNOWN';
                const freshnessClass = freshness === 'LIVE_DAILY' ? 'freshness-live' : 
                                      freshness === 'QUARTERLY_API' ? 'freshness-quarterly' : 
                                      freshness === 'ANNUAL_DATASET' ? 'freshness-annual' : '';
                const freshnessLabel = freshness.replace(/_/g, ' ');
                
                return `
                  <div style="background:#0a0c0e; padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                      <span style="color:#fff; font-weight:600;">${regionName}</span>
                      <span class="region-freshness ${freshnessClass}" style="margin-left:8px; font-size:10px;">${freshnessLabel}</span>
                    </div>
                    <div style="text-align:right;">
                      <div style="color:#00ffe0; font-weight:600;">${regionGwh} GWh/day</div>
                      <div style="color:#999; font-size:11px;">${regionSolar} Solar</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      card.innerHTML = `
        <h3>${icon} ${categoryName}</h3>
        <div class="geo-badge">üåç GLOBAL TOTAL (All 6 Regions)</div>
        <div class="source-meta">
          <div class="meta-item">
            <div class="meta-label">Daily Energy (Global)</div>
            <div class="meta-value">${globalGwhDaily} GWh/day</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Total kWh (Global)</div>
            <div class="meta-value">${globalTotalKwh.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Solar Units (Global)</div>
            <div class="meta-value">${globalTotalSolar.toFixed(2)}</div>
          </div>
        </div>
        ${regionsHTML}
        <div class="data-vintage-notice" style="margin-top:15px; font-size:11px;">
          <strong>Data Sources:</strong> Live APIs (EIA, DOE, USDA, Mempool), Quarterly APIs (Eurostat), IEA/UN 2023 datasets. 
          Three-tier fallback ensures 100% coverage.
        </div>
      `;
      
      reportDiv.appendChild(card);
    });
  }
  
  // Add toggle functionality for narratives
  document.querySelectorAll('.narrative-toggle').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const content = document.getElementById(targetId);
      const icon = this.querySelector('.toggle-icon');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.classList.remove('rotated');
      } else {
        content.classList.add('expanded');
        icon.classList.add('rotated');
      }
    });
  });

  // --- global trend ---
  const days=[...new Set(data.map(x=>x.day))].sort();
  const dayTotals=days.map(d=>data.filter(x=>x.day===d).reduce((s,x)=>s+(+x.kwh),0)/1e6);
  new Chart(document.getElementById('globalTrend'),{
    type:'line',
    data:{labels:days,datasets:[{label:'Global Energy (GWh/day)',data:dayTotals,borderColor:'#00ffe0',tension:0.3,fill:false}]},
    options:{
      plugins:{
        tooltip:{
          callbacks:{
            label: function(context) {
              return `${context.parsed.y.toFixed(2)} GWh/day`;
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#ccc'}},
        y:{
          ticks:{color:'#ccc'},
          beginAtZero:true,
          title:{
            display:true,
            text:'GWh/day',
            color:'#00ffe0'
          }
        }
      }
    }
  });

  // --- sector breakdown chart ---
  // Sort categories by energy consumption for better visualization
  const sortedCats = cats.sort((a,b) => totals[b].kwh - totals[a].kwh);
  new Chart(document.getElementById('sectorChart'),{
    type:'bar',
    data:{
      labels:sortedCats,
      datasets:[{
        label:'Cumulative MWh',
        data:sortedCats.map(c=>totals[c].kwh/1e3),
        backgroundColor:'#00ffe0'
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label: function(context) {
              const gwh = context.parsed.y / 1000;
              return `${gwh.toFixed(2)} GWh/day`;
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'#ccc'}},
        y:{
          type:'logarithmic',
          ticks:{
            color:'#ccc',
            callback: function(value) {
              if (value >= 1000000) return (value/1000000).toFixed(0) + 'M';
              if (value >= 1000) return (value/1000).toFixed(0) + 'K';
              return value;
            }
          },
          title:{
            display:true,
            text:'MWh (log scale)',
            color:'#00ffe0'
          }
        }
      }
    }
  });

  // --- audit table ---
  const tbody=document.querySelector('#auditTable tbody');
  data.slice(0,50).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.day}</td><td>${r.category}</td>
      <td>${(+r.kwh).toLocaleString()}</td><td>${(+r.solar_units).toFixed(3)}</td>
      <td>${r.source}</td><td>${r.verification_level}</td>`;
    tbody.appendChild(tr);
  });

  // --- export JSON ---
  document.getElementById('exportBtn').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='global_energy_audit.json';a.click();
    URL.revokeObjectURL(url);
  });
}
loadData();
</script>
</body>
</html>
