<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TC-S Wallet Prototype</title>
  <style>
  body {
    font-family: system-ui, sans-serif;
    background: #f8fdfc;
    margin: 0;
    padding: 0;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .wallet-box {
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    background: #ffffff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #003a33;
    margin-bottom: 0.4rem;
  }

  .sub {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 1rem;
  }

  pre {
    background: #eef7f4;
    padding: 0.8rem;
    border-radius: 6px;
    font-size: 0.9rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .btn {
    background: #00aa88;
    color: white;
    border: none;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    margin: 0.3rem 0.3rem 0 0;
    display: inline-block;
    width: calc(100% - 1rem);
    max-width: 400px;
  }

  .btn:hover {
    background: #008f72;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .button-row {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  @media screen and (min-width: 600px) {
    .button-row {
      flex-direction: row;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn {
      width: auto;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <h1>The Current-See: AI Wallet Prototype</h1>
    <p class="sub">A live demonstration of our AI-powered, energy-conscious wallet system. Data is streaming in real time from our working prototype.</p>

    <div class="wallet-box">
      <div class="title">User 1 Wallet</div>
      <div id="wallet1">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">User 2 Wallet</div>
      <div id="wallet2">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">Most Recent Transfers</div>
      <div id="transfer-log-display" style="padding: 1rem; font-size: 0.9rem;">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">WalletWhisper: Sustainability Tip Preview</div>
      <p>"Consider switching to a reusable bottle. It saves ~0.2 kWh per use."</p>
      <div class="button-row">
        <button class="btn" onclick="walletWhisper('Consider switching to a reusable bottle. It saves 0.2 kilowatt-hours per use.')">Play Voice Tip</button>
      </div>
    </div>

    <div class="wallet-box button-row">
      <a href="#" id="launch-ai-wallet" class="btn">Launch Full AI Wallet</a>
      <a href="https://demo-wallet-transfer-tdfranklin101.replit.app/" class="btn" target="_blank" rel="noopener noreferrer">View 2-Wallet Demo</a>
      <a href="https://thecurrentsee.org/signup" class="btn" target="_blank" rel="noopener noreferrer">Join the TC-S Network</a>
    </div>
    
    <!-- Loading modal for the Full AI Wallet -->
    <div id="loading-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
      <div style="background-color: white; padding: 2rem; border-radius: 10px; text-align: center; max-width: 500px; width: 90%;">
        <h3 style="margin-top: 0; color: #00aa88;">Starting Full AI Wallet...</h3>
        <p>The wallet app is waking up and loading. This may take 10-15 seconds.</p>
        <div style="margin: 1.5rem 0; height: 6px; background-color: #f0f0f0; border-radius: 3px; overflow: hidden;">
          <div id="loading-progress" style="height: 100%; width: 0%; background-color: #00aa88; transition: width 0.5s;"></div>
        </div>
        <div id="loading-status">Initializing connection...</div>
      </div>
    </div>
    
    <div class="wallet-box" style="text-align: center; margin-top: 20px;">
      <a href="/index.html" class="btn" style="background-color: #7bc144; color: white; text-decoration: none; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 50px; display: inline-block;">Return to Home</a>
    </div>
  </div>

  <script>
    // Try multiple potential URLs in case one isn't working
    const backendUrls = [
      "https://cross-platform-mobile-tdfranklin101.replit.app",
      "https://crossplatformmobile.tdfrankl.repl.co",
      "https://crossplatformmobile.tdfrankl.replit.app"
    ];
    let backendBase = backendUrls[0]; // Start with the first one

    // Try all available backend URLs
    let currentUrlIndex = 0;
    let connectAttempts = 0;
    const maxAttempts = 3;
    
    // Mock data to display if all connection attempts fail
    const mockWalletData = {
      user1: { balance: 123.45 },
      user2: { balance: 67.89 }
    };
    
    const mockTransferData = [
      { from: "User1", to: "User2", amount: 10.0, timestamp: "2025-04-15T12:34:56Z" },
      { from: "User2", to: "User1", amount: 5.0, timestamp: "2025-04-15T10:30:00Z" },
      { from: "User1", to: "Admin", amount: 2.5, timestamp: "2025-04-14T15:45:22Z" }
    ];
    
    function tryNextBackendUrl() {
      currentUrlIndex = (currentUrlIndex + 1) % backendUrls.length;
      backendBase = backendUrls[currentUrlIndex];
      console.log(`Trying next backend URL: ${backendBase}`);
      connectAttempts++;
    }
    
    function loadWalletData() {
      fetch(`${backendBase}/wallets`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          // Reset attempts counter on success
          connectAttempts = 0;
          return res.json();
        })
        .then(data => {
          document.getElementById("wallet1").innerText = `${data.user1.balance.toFixed(2)} Solar`;
          document.getElementById("wallet2").innerText = `${data.user2.balance.toFixed(2)} Solar`;
          
          // Keep the fixed Full Demo URL - no need to update it
          // document.getElementById('launch-demo-btn').href = backendBase;
        })
        .catch(error => {
          console.error('Error loading wallet data:', error);
          
          // Try next URL if available and we haven't exhausted all attempts
          if (connectAttempts < maxAttempts) {
            tryNextBackendUrl();
            // Try again immediately with new URL
            loadWalletData();
            return;
          }
          
          // Display mock data if all connection attempts fail
          if (connectAttempts >= maxAttempts) {
            document.getElementById("wallet1").innerText = `${mockWalletData.user1.balance.toFixed(2)} Solar`;
            document.getElementById("wallet2").innerText = `${mockWalletData.user2.balance.toFixed(2)} Solar`;
          } else {
            document.getElementById("wallet1").innerText = `Error loading wallet data`;
            document.getElementById("wallet2").innerText = `Error loading wallet data`;
          }
        });
    }

    function loadTransferLog() {
      fetch(`${backendBase}/transfers`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          displayFormattedTransfers(data.slice(-5).reverse());
        })
        .catch(error => {
          console.error('Error loading transfer data:', error);
          
          // Display mock transfer data if all attempts fail
          if (connectAttempts >= maxAttempts) {
            displayFormattedTransfers(mockTransferData);
          } else {
            document.getElementById("transfer-log-display").innerHTML = `<div class="error">Error loading transfer data: Connection issue</div>`;
          }
        });
    }
    
    function displayFormattedTransfers(transfers) {
      const transfersElement = document.getElementById("transfer-log-display");
      transfersElement.innerHTML = '';
      
      if (!transfers || transfers.length === 0) {
        transfersElement.innerHTML = '<div style="color: #666; font-style: italic;">No transfers found</div>';
        return;
      }
      
      transfers.forEach(transfer => {
        const date = new Date(transfer.timestamp);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const transferItem = document.createElement('div');
        transferItem.style.marginBottom = '0.8rem';
        transferItem.style.borderBottom = '1px solid #eee';
        transferItem.style.paddingBottom = '0.8rem';
        
        transferItem.innerHTML = `
          <div style="display: flex; justify-content: space-between;">
            <div>
              <strong>${transfer.from}</strong> â†’ <strong>${transfer.to}</strong>
            </div>
            <div style="font-weight: bold; color: #006655;">
              ${transfer.amount.toFixed(2)} Solar
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #777; margin-top: 0.3rem;">
            ${formattedDate}
          </div>
        `;
        
        transfersElement.appendChild(transferItem);
      });
    }

    function walletWhisper(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.pitch = 1.1;
      msg.rate = 1;
      window.speechSynthesis.speak(msg);
    }

    setInterval(() => {
      loadWalletData();
      loadTransferLog();
    }, 3000);

    window.onload = () => {
      loadWalletData();
      loadTransferLog();
      
      // Setup AI Wallet launch with "wake up" functionality
      const launchButton = document.getElementById('launch-ai-wallet');
      const loadingModal = document.getElementById('loading-modal');
      const loadingProgress = document.getElementById('loading-progress');
      const loadingStatus = document.getElementById('loading-status');
      
      launchButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Show loading modal
        loadingModal.style.display = 'flex';
        
        // Try each of the app URLs in sequence
        let appUrls = [...backendUrls]; // Create a copy of the backend URLs
        let currentAppUrlIndex = 0;
        let pingAttempts = 0;
        const maxPingAttempts = 3;
        
        // Update the progress bar
        function updateProgress(percent) {
          loadingProgress.style.width = `${percent}%`;
        }
        
        // Ping the app to wake it up
        function pingApp() {
          const currentAppUrl = appUrls[currentAppUrlIndex];
          updateProgress(15 + pingAttempts * 20);
          loadingStatus.textContent = `Waking up wallet app (attempt ${pingAttempts + 1})...`;
          
          // First try a GET request to /ping
          fetch(`${currentAppUrl}/ping`, { method: 'GET' })
            .then(res => {
              if (res.ok) {
                // App is awake, redirect
                loadingStatus.textContent = 'Success! Launching wallet app...';
                updateProgress(100);
                
                // Short delay before redirect for visual feedback
                setTimeout(() => {
                  window.open(currentAppUrl, '_blank');
                  loadingModal.style.display = 'none';
                  updateProgress(0);
                }, 1000);
              } else {
                throw new Error('App not ready yet with GET request');
              }
            })
            // If GET fails, try a POST request which sometimes works better for waking up Replit apps
            .catch(() => {
              loadingStatus.textContent = `Trying alternative wake method...`;
              
              return fetch(`${currentAppUrl}/`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'wake' })
              })
              .then(res => {
                // Any response here is good, means the app is responsive
                loadingStatus.textContent = 'Success! Launching wallet app...';
                updateProgress(100);
                
                setTimeout(() => {
                  window.open(currentAppUrl, '_blank');
                  loadingModal.style.display = 'none';
                  updateProgress(0);
                }, 1000);
              })
              .catch(err => {
                throw new Error('App not ready after both GET and POST attempts');
              });
            })
            .catch(err => {
              pingAttempts++;
              
              if (pingAttempts >= maxPingAttempts) {
                // Try next URL
                currentAppUrlIndex++;
                pingAttempts = 0;
                
                if (currentAppUrlIndex >= appUrls.length) {
                  // All URLs failed, just attempt direct launch of first URL
                  loadingStatus.textContent = 'Unable to wake app automatically. Launching anyway...';
                  updateProgress(100);
                  
                  setTimeout(() => {
                    window.open(appUrls[0], '_blank');
                    loadingModal.style.display = 'none';
                    updateProgress(0);
                  }, 2000);
                  
                  return;
                }
              }
              
              // Try again after a short delay
              setTimeout(pingApp, 1500);
            });
        }
        
        // Start the ping process
        pingApp();
      });
      
      // Allow clicking outside the modal to close it
      loadingModal.addEventListener('click', function(e) {
        if (e.target === loadingModal) {
          loadingModal.style.display = 'none';
          loadingProgress.style.width = '0%';
        }
      });
    };
  </script>
</body>
</html>