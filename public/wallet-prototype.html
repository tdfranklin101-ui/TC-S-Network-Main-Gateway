<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TC-S Wallet Prototype</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #f8fdfc; margin: 2rem; }
    .wallet-box { border: 1px solid #ccc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; background: #fff; }
    .title { font-size: 1.4rem; font-weight: bold; color: #003a33; }
    .sub { font-size: 0.9rem; color: #555; }
    pre { background: #eef7f4; padding: 1rem; border-radius: 6px; font-size: 0.85rem; overflow-x: auto; }
    .btn { background: #00aa88; color: white; border: none; padding: 0.7rem 1rem; font-size: 1rem; border-radius: 6px; cursor: pointer; margin-top: 1rem; }
    .btn:hover { background: #008f72; }
  </style>
</head>
<body>
  <h1>The Current-See: AI Wallet Prototype</h1>
  <p class="sub">A live demonstration of our AI-powered, energy-conscious wallet system. Data is streaming in real time from our working prototype.</p>

  <div class="wallet-box">
    <div class="title">User 1 Wallet</div>
    <div id="wallet1">Loading...</div>
  </div>

  <div class="wallet-box">
    <div class="title">User 2 Wallet</div>
    <div id="wallet2">Loading...</div>
  </div>

  <div class="wallet-box">
    <div class="title">Most Recent Transfers</div>
    <pre id="transfer-log">Loading...</pre>
  </div>

  <div class="wallet-box">
    <div class="title">WalletWhisper: Sustainability Tip Preview</div>
    <p>"Consider switching to a reusable bottle. It saves ~0.2 kWh per use."</p>
    <button class="btn" onclick="walletWhisper('Consider switching to a reusable bottle. It saves 0.2 kilowatt-hours per use.')">Play Voice Tip</button>
  </div>

  <div class="wallet-box">
    <a href="https://cross-platform-mobile-tdfranklin101.replit.app" class="btn" id="launch-demo-btn">Launch Full Demo</a>
    <a href="/join" class="btn">Join the TC-S Network</a>
  </div>

  <script>
    // Try multiple potential URLs in case one isn't working
    const backendUrls = [
      "https://cross-platform-mobile-tdfranklin101.replit.app",
      "https://crossplatformmobile.tdfrankl.repl.co",
      "https://crossplatformmobile.tdfrankl.replit.app"
    ];
    let backendBase = backendUrls[0]; // Start with the first one

    // Try all available backend URLs
    let currentUrlIndex = 0;
    let connectAttempts = 0;
    const maxAttempts = 3;
    
    // Mock data to display if all connection attempts fail
    const mockWalletData = {
      user1: { balance: 123.45 },
      user2: { balance: 67.89 }
    };
    
    const mockTransferData = [
      { from: "User1", to: "User2", amount: 10.0, timestamp: "2025-04-15T12:34:56Z" },
      { from: "User2", to: "User1", amount: 5.0, timestamp: "2025-04-15T10:30:00Z" },
      { from: "User1", to: "Admin", amount: 2.5, timestamp: "2025-04-14T15:45:22Z" }
    ];
    
    function tryNextBackendUrl() {
      currentUrlIndex = (currentUrlIndex + 1) % backendUrls.length;
      backendBase = backendUrls[currentUrlIndex];
      console.log(`Trying next backend URL: ${backendBase}`);
      connectAttempts++;
    }
    
    function loadWalletData() {
      fetch(`${backendBase}/wallets`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          // Reset attempts counter on success
          connectAttempts = 0;
          return res.json();
        })
        .then(data => {
          document.getElementById("wallet1").innerText = `${data.user1.balance.toFixed(2)} Solar`;
          document.getElementById("wallet2").innerText = `${data.user2.balance.toFixed(2)} Solar`;
          
          // Update Launch Demo button with working URL
          document.getElementById('launch-demo-btn').href = backendBase;
        })
        .catch(error => {
          console.error('Error loading wallet data:', error);
          
          // Try next URL if available and we haven't exhausted all attempts
          if (connectAttempts < maxAttempts) {
            tryNextBackendUrl();
            // Try again immediately with new URL
            loadWalletData();
            return;
          }
          
          // Display mock data if all connection attempts fail
          if (connectAttempts >= maxAttempts) {
            document.getElementById("wallet1").innerText = `${mockWalletData.user1.balance.toFixed(2)} Solar`;
            document.getElementById("wallet2").innerText = `${mockWalletData.user2.balance.toFixed(2)} Solar`;
          } else {
            document.getElementById("wallet1").innerText = `Error loading wallet data`;
            document.getElementById("wallet2").innerText = `Error loading wallet data`;
          }
        });
    }

    function loadTransferLog() {
      fetch(`${backendBase}/transfers`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          document.getElementById("transfer-log").innerText = JSON.stringify(data.slice(-5).reverse(), null, 2);
        })
        .catch(error => {
          console.error('Error loading transfer data:', error);
          
          // Display mock transfer data if all attempts fail
          if (connectAttempts >= maxAttempts) {
            document.getElementById("transfer-log").innerText = JSON.stringify(mockTransferData, null, 2);
          } else {
            document.getElementById("transfer-log").innerText = `Error loading transfer data: ${error.message}`;
          }
        });
    }

    function walletWhisper(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.pitch = 1.1;
      msg.rate = 1;
      window.speechSynthesis.speak(msg);
    }

    setInterval(() => {
      loadWalletData();
      loadTransferLog();
    }, 3000);

    window.onload = () => {
      loadWalletData();
      loadTransferLog();
    };
  </script>
</body>
</html>