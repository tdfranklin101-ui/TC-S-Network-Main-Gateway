<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TC-S Wallet Prototype</title>
  <style>
  body {
    font-family: system-ui, sans-serif;
    background: #f8fdfc;
    margin: 0;
    padding: 0;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .wallet-box {
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    background: #ffffff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #003a33;
    margin-bottom: 0.4rem;
  }

  .sub {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 1rem;
  }

  pre {
    background: #eef7f4;
    padding: 0.8rem;
    border-radius: 6px;
    font-size: 0.9rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .btn {
    background: #00aa88;
    color: white;
    border: none;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
    margin: 0.3rem 0.3rem 0 0;
    display: inline-block;
    width: calc(100% - 1rem);
    max-width: 400px;
  }

  .btn:hover {
    background: #008f72;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .button-row {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  @media screen and (min-width: 600px) {
    .button-row {
      flex-direction: row;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn {
      width: auto;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <h1>The Current-See: AI Wallet Prototype</h1>
    <p class="sub">A live demonstration of our AI-powered, energy-conscious wallet system. Data is streaming in real time from our working prototype.</p>

    <div class="wallet-box">
      <div class="title">User 1 Wallet</div>
      <div id="wallet1">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">User 2 Wallet</div>
      <div id="wallet2">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">Most Recent Transfers</div>
      <div id="transfer-log-display" style="padding: 1rem; font-size: 0.9rem;">Loading...</div>
    </div>

    <div class="wallet-box">
      <div class="title">WalletWhisper: Sustainability Tip Preview</div>
      <p>"Consider switching to a reusable bottle. It saves ~0.2 kWh per use."</p>
      <div class="button-row">
        <button class="btn" onclick="walletWhisper('Consider switching to a reusable bottle. It saves 0.2 kilowatt-hours per use.')">Play Voice Tip</button>
      </div>
    </div>

    <div class="wallet-box button-row">
      <a href="https://cross-platform-mobile-tdfranklin101.replit.app" class="btn" target="_blank" rel="noopener noreferrer">Launch Full AI Wallet</a>
      <a href="https://cross-platform-mobile-tdfranklin101.replit.app/transfer-demo" class="btn" target="_blank" rel="noopener noreferrer">View 2-Wallet Demo</a>
      <a href="/join" class="btn">Join the TC-S Network</a>
    </div>
  </div>

  <script>
    // Try multiple potential URLs in case one isn't working
    const backendUrls = [
      "https://cross-platform-mobile-tdfranklin101.replit.app",
      "https://crossplatformmobile.tdfrankl.repl.co",
      "https://crossplatformmobile.tdfrankl.replit.app"
    ];
    let backendBase = backendUrls[0]; // Start with the first one

    // Try all available backend URLs
    let currentUrlIndex = 0;
    let connectAttempts = 0;
    const maxAttempts = 3;
    
    // Mock data to display if all connection attempts fail
    const mockWalletData = {
      user1: { balance: 123.45 },
      user2: { balance: 67.89 }
    };
    
    const mockTransferData = [
      { from: "User1", to: "User2", amount: 10.0, timestamp: "2025-04-15T12:34:56Z" },
      { from: "User2", to: "User1", amount: 5.0, timestamp: "2025-04-15T10:30:00Z" },
      { from: "User1", to: "Admin", amount: 2.5, timestamp: "2025-04-14T15:45:22Z" }
    ];
    
    function tryNextBackendUrl() {
      currentUrlIndex = (currentUrlIndex + 1) % backendUrls.length;
      backendBase = backendUrls[currentUrlIndex];
      console.log(`Trying next backend URL: ${backendBase}`);
      connectAttempts++;
    }
    
    function loadWalletData() {
      fetch(`${backendBase}/wallets`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          // Reset attempts counter on success
          connectAttempts = 0;
          return res.json();
        })
        .then(data => {
          document.getElementById("wallet1").innerText = `${data.user1.balance.toFixed(2)} Solar`;
          document.getElementById("wallet2").innerText = `${data.user2.balance.toFixed(2)} Solar`;
          
          // Keep the fixed Full Demo URL - no need to update it
          // document.getElementById('launch-demo-btn').href = backendBase;
        })
        .catch(error => {
          console.error('Error loading wallet data:', error);
          
          // Try next URL if available and we haven't exhausted all attempts
          if (connectAttempts < maxAttempts) {
            tryNextBackendUrl();
            // Try again immediately with new URL
            loadWalletData();
            return;
          }
          
          // Display mock data if all connection attempts fail
          if (connectAttempts >= maxAttempts) {
            document.getElementById("wallet1").innerText = `${mockWalletData.user1.balance.toFixed(2)} Solar`;
            document.getElementById("wallet2").innerText = `${mockWalletData.user2.balance.toFixed(2)} Solar`;
          } else {
            document.getElementById("wallet1").innerText = `Error loading wallet data`;
            document.getElementById("wallet2").innerText = `Error loading wallet data`;
          }
        });
    }

    function loadTransferLog() {
      fetch(`${backendBase}/transfers`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          displayFormattedTransfers(data.slice(-5).reverse());
        })
        .catch(error => {
          console.error('Error loading transfer data:', error);
          
          // Display mock transfer data if all attempts fail
          if (connectAttempts >= maxAttempts) {
            displayFormattedTransfers(mockTransferData);
          } else {
            document.getElementById("transfer-log-display").innerHTML = `<div class="error">Error loading transfer data: Connection issue</div>`;
          }
        });
    }
    
    function displayFormattedTransfers(transfers) {
      const transfersElement = document.getElementById("transfer-log-display");
      transfersElement.innerHTML = '';
      
      if (!transfers || transfers.length === 0) {
        transfersElement.innerHTML = '<div style="color: #666; font-style: italic;">No transfers found</div>';
        return;
      }
      
      transfers.forEach(transfer => {
        const date = new Date(transfer.timestamp);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const transferItem = document.createElement('div');
        transferItem.style.marginBottom = '0.8rem';
        transferItem.style.borderBottom = '1px solid #eee';
        transferItem.style.paddingBottom = '0.8rem';
        
        transferItem.innerHTML = `
          <div style="display: flex; justify-content: space-between;">
            <div>
              <strong>${transfer.from}</strong> â†’ <strong>${transfer.to}</strong>
            </div>
            <div style="font-weight: bold; color: #006655;">
              ${transfer.amount.toFixed(2)} Solar
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #777; margin-top: 0.3rem;">
            ${formattedDate}
          </div>
        `;
        
        transfersElement.appendChild(transferItem);
      });
    }

    function walletWhisper(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.pitch = 1.1;
      msg.rate = 1;
      window.speechSynthesis.speak(msg);
    }

    setInterval(() => {
      loadWalletData();
      loadTransferLog();
    }, 3000);

    window.onload = () => {
      loadWalletData();
      loadTransferLog();
    };
  </script>
</body>
</html>