// â”€â”€ 1) Define the four stages (screen-space, or convert from your normalized coords)
const STAGES = [
  { key: 'sun',    label: 'Sun (origin energy)', icon: 'â˜€ï¸',  x: 110, y: 110 },
  { key: 'life',   label: 'Life',                 icon: 'ðŸŒ±',  x: 185, y: 310 },
  { key: 'neural', label: 'Neural computation',   icon: 'ðŸ§ ',  x: 285, y: 355 },
  { key: 'mind',   label: 'Conscious thought',    icon: 'ðŸ’¡',  x: 420, y: 540 },
];

// If your code already has normalized stage points (0..1), replace x/y above with nx, ny
// and convert like: const {x,y} = toCanvas(stage.nx, stage.ny);

// â”€â”€ 2) Call this from your animation loop AFTER the path/dot is drawn
function renderStageLabels(ctx, activeIndex) {
  STAGES.forEach((s, i) => {
    drawLabel(ctx, s.x, s.y, `${s.icon} ${s.label}`, i === activeIndex ? 1 : 0.45);
  });
}

// Rounded label with pointerless pill, auto width
function drawLabel(ctx, x, y, text, alpha = 1) {
  ctx.save();
  ctx.globalAlpha = alpha;

  ctx.font = '15px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
  const padX = 12, padY = 8, radius = 12;
  const metrics = ctx.measureText(text);
  const textW = Math.ceil(metrics.width);
  const w = textW + padX * 2;
  const h = 32;

  // Center the pill above the point a bit
  const bx = x - w / 2;
  const by = y - h - 16;

  // pill
  ctx.beginPath();
  roundRect(ctx, bx, by, w, h, radius);
  ctx.fillStyle = 'rgba(255, 204, 102, 0.12)'; // soft amber fill (matches your theme)
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(255, 204, 102, 0.75)';
  ctx.stroke();

  // text
  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.fillText(text, bx + padX, by + h/2 + 5);

  ctx.restore();
}

// helper for rounded rects
function roundRect(ctx, x, y, w, h, r) {
  const rr = Math.min(r, w/2, h/2);
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y,     x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x,     y + h, rr);
  ctx.arcTo(x,     y + h, x,     y,     rr);
  ctx.arcTo(x,     y,     x + w, y,     rr);
  ctx.closePath();
}

// â”€â”€ 3) Wire into your existing loop
// Suppose you already compute `currentStageIndex` (0..3) as the dot advances.
function drawFrame(ctx) {
  // ... your existing drawing (bounds, dashed path, dot, etc.)

  renderStageLabels(ctx, currentStageIndex);
}

// â”€â”€ 4) Mobile-friendly instructions (no hover)
const footerEl = document.getElementById('footer-instructions');
if (footerEl) {
  footerEl.textContent = 'Tap/click to pause â€¢ Labels show automatically';
}

// â”€â”€ 5) OPTIONAL: if you previously had hover listeners, disable/remove them
// e.g. canvas.removeEventListener('mousemove', onHoverStage);