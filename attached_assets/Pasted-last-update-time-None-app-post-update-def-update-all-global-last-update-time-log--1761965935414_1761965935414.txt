last_update_time = None

@app.post("/update")
def update_all():
    global last_update_time
    log_id, started = log_update_start()
    updated, missing = [], []
    meta = {"node":"energy-aggregator","version":"1.0","tz":"UTC"}

    try:
        rights = {"privacy":"ENFORCED","non_discrimination":"ENFORCED","auditability":"FULL"}

        # MONEY (Bitcoin via CBECI)
        if tiered_fetch(feed_money_kwh, "money", rights): updated.append("money")
        else: missing.append("money")

        # EIA sectors (DIRECT)
        if EIA_API_KEY:
            if tiered_fetch(feed_housing_kwh, "housing", rights): updated.append("housing")
            else: missing.append("housing")

            if tiered_fetch(feed_digital_services_kwh, "digital-services", rights): updated.append("digital-services")
            else: missing.append("digital-services")

            if tiered_fetch(feed_manufacturing_kwh, "manufacturing", rights): updated.append("manufacturing")
            else: missing.append("manufacturing")

            if tiered_fetch(feed_transport_kwh, "transport", rights): updated.append("transport")
            else: missing.append("transport")

            if tiered_fetch(feed_food_agriculture_kwh, "food", rights): updated.append("food")
            else: missing.append("food")
        else:
            # If no EIA key, mark all EIA-driven categories missing
            missing += ["housing","digital-services","manufacturing","transport","food"]

        status = "SUCCESS" if len(missing) == 0 else ("PARTIAL" if len(updated) > 0 else "FAIL")
        last_update_time = dt.datetime.utcnow().isoformat()
        meta["duration_sec"] = (dt.datetime.utcnow() - started).total_seconds()

        log_update_finish(log_id, status, updated, missing, None, meta)
        return {"status": status, "updated": updated, "missing": missing, "timestamp": last_update_time}

    except Exception as e:
        err = f"{e}\n{traceback.format_exc()}"
        log_update_finish(log_id, "FAIL", updated, missing or ["money","housing","digital-services","manufacturing","transport","food"], err, meta)
        return {"status":"FAIL","error":str(e)}